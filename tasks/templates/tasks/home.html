<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <a href="{% url 'logout' %}">Logout {{ user }}</a>

    <h2>Добавить новую задачу</h2>
    <form id="task-form">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Добавить задачу</button>
    </form>

    <div id="task-list">
        {% for task in tasks %}
            <div id="task-{{ task.id }}" class="task">
                <h2>{{ task.title }}</h2>
                <p>{{ task.due_date|date:"d.m.Y, H:i" }}</p>
                <p>{{ task.description }}</p>
                <button onclick="deleteTask({{ task.id }})">Удалить</button>
                <hr>
            </div>
        {% empty %}
            <h2 id="no-tasks">no tasks</h2>
        {% endfor %}
    </div>

    <script>
        // Добавление задачи через AJAX
        $('#task-form').submit(function(event) {
            event.preventDefault();  // Останавливаем стандартное поведение формы

            $.ajax({
                url: '{% url "add_task" %}',
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    if (response.status === 'success') {
                        // Удаляем сообщение "no tasks", если оно существует
                        $('#no-tasks').remove();

                        // Создаем HTML для новой задачи
                        const task = response.task;
                        let formattedDate = "";
                        if (task.due_date != ""){
                            const taskDueDate = new Date(task.due_date);
                            formattedDate = taskDueDate.toLocaleDateString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                        console.log(formattedDate);
                        const newTaskHtml = `
                            <div id="task-${task.id}" class="task">
                                <h2>${task.title}</h2>
                                <p>${formattedDate}</p>
                                <p>${task.description}</p>
                                <button onclick="deleteTask(${task.id})">Удалить</button>
                                <hr>
                            </div>`;
                        
                        // Добавляем новую задачу в список
                        $('#task-list').append(newTaskHtml);
                        sortTasks();
                        $('#task-form')[0].reset();  // Очищаем форму
                    } else {
                        alert('Ошибка при добавлении задачи.');
                    }
                },
                error: function(response) {
                    alert('Ошибка при добавлении задачи. Проверьте форму на наличие ошибок.');
                }
            });
        });

        function sortTasks() {
            // Получаем все задачи
            let tasks = $('#task-list .task').get();

            // Сортируем задачи сначала по due_date, потом по created_at
            tasks.sort(function(a, b) {
                const dueDateA = new Date($(a).find('p').eq(0).text()); // Парсим дату выполнения
                const dueDateB = new Date($(b).find('p').eq(0).text()); // Парсим дату выполнения

                // Если due_date равны (NaN для задач без срока), сортируем по created_at
                if (isNaN(dueDateA.getTime()) && isNaN(dueDateB.getTime())) {
                    // Если обе задачи не имеют due_date, сортируем по порядку создания (например, по порядку появления в DOM)
                    const createdAtA = new Date($(a).find('hr').prev().text());
                    const createdAtB = new Date($(b).find('hr').prev().text());
                    return createdAtA - createdAtB;
                }

                // Если одна из задач имеет due_date, то сортируем по due_date
                if (isNaN(dueDateA.getTime())) return 1;  // Задачи без due_date идут после задач с due_date
                if (isNaN(dueDateB.getTime())) return -1;

                // Если due_date существует, сортируем по due_date
                return dueDateA - dueDateB;
            });

            // Перемещаем отсортированные задачи обратно в DOM
            $.each(tasks, function(index, task) {
                $('#task-list').append(task);
            });
        }

        function deleteTask(taskId) {
            $.ajax({
                url: `/delete_task/${taskId}/`,
                type: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function(response) {
                    if (response.status === 'success') {
                        $(`#task-${taskId}`).remove();  // Удаляем задачу из DOM
                        
                        // Проверяем, остались ли задачи. Если нет, добавляем сообщение "no tasks".
                        if ($('#task-list').children().length === 0) {
                            $('#task-list').append('<h2 id="no-tasks">no tasks</h2>');
                        }
                    } else {
                        alert('Ошибка при удалении задачи.');
                    }
                },
                error: function() {
                    alert('Ошибка при удалении задачи.');
                }
            });
        }
    </script>
</body>
</html>